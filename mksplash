#!/bin/bash
set -euo pipefail

PLYMOUTH_SOURCE="https://gitlab.archlinux.org/archlinux/packaging/packages/plymouth.git"
UNPATCHED_PATH="/usr/lib/plymouth/two-step.so.old"

verbose_logging=false

title=
vid=
fps="30"
width=

usage() {
  cat <<EOF
Usage: $(basename "$0") [-t title] [-i input] [-f fps] [-u] [-v] [-h]
  -t TITLE    Set the title (required)
  -i INPUT    Input file/path (required)
  -f FPS      Framerate (defaults to 30)
  -u          Unpatch two-step (not for use with other flags)
  -v          Verbose
  -h          Show help
Examples:
  $(basename "$0") -t "My Bootsplash" -i input.mp4
EOF
}

unpatch() {
  if [[ -f "$UNPATCHED_PATH" ]]; then
    mv "$UNPATCHED_PATH" "/usr/lib/plymouth/two-step.so"
    echo "Unpatched successfully"
  else
    echo "Patch not found"
  fi
}

while getopts "tifuvh" opt; do
  case "$opt" in 
    t) title=$optarg ;;
    i) vid=$optarg ;;
    f) fps=$optarg ;;
    u) unpatch; exit 0 ;;
    v) verbose_logging=true ;;
    h) usage; exit 0 ;;
  esac
done
shift $((OPTIND - 1))

if [[ -z "$title" || -z "$vid" ]]; then
  usage
  exit 1
fi

if !$verbose_logging; then
  exec 3>&1 4>&2

  exec >/dev/null 2>&1

  log() { echo "$@" >&3; }
  err() { echo "$@" >&4; }
else
  log() { echo "$@" >&1; }
  err() { echo "$@" >&2; }
fi

if [[ "$fps" != "30" ]]; then
  log "Patching two-step..."
  # the directory of the script
  DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

  # the temp directory used, within $DIR
  # omit the -p parameter to create a temporal directory in the default location
  WORK_DIR=`mktemp -d`

  # check if tmp dir was created
  if [[ ! "$WORK_DIR" || ! -d "$WORK_DIR" ]]; then
    err "Could not create temp dir"
    exit 1
  fi

  # deletes the temp directory
  function cleanup {
    rm -rf "$WORK_DIR"
    log "Deleted temp working directory $WORK_DIR"
  }

  # register the cleanup function to be called on the EXIT signal
  trap cleanup EXIT

  cd "$WORK_DIR"
  git clone $PLYMOUTH_SOURCE
  cd plymouth
  sed -i "s|logo=/usr/share/pixmaps/archlinux-logo.png|logo=/usr/share/pixmaps/archlinux-logo.png \\\\\n    -Dc_args='-DFRAMES_PER_SECOND=${fps}'|" PKGBUILD
  makepkg -s --noconfirm
  mv /usr/lib/plymouth/two-step.so /usr/lib/plymouth/two-step.so.old
  cp ./pkg/plymouth/usr/lib/plymouth/two-step.so /usr/lib/plymouth/
  log "Successfully patched two-step to ${fps} fps"
  cd "$DIR"
else
  log "Checking for patch"
  unpatch
fi

log "Creating theme dir..."
theme_dir="/usr/share/plymouth/themes/$title"
mkdir -p "$theme_dir"
log "Created theme dir"

log "Creating theme files..."
# Build the video filter string
vf=""
if [[ -n "$width" ]]; then
  vf+="scale=${width}:-2:force_original_aspect_ratio=decrease,"
fi
vf+="fps=${fps}"

# Extract frames
ffmpeg -y -i "$vid" -vf "$vf" "$theme_dir/startup-animation-%04d.png"

# Copy necessary files
cp "/usr/share/mksplash/*.png" "$theme_dir/" 

# Write the .plymouth theme file
cat > "$theme_dir/$title.plymouth" <<'EOF'
[Plymouth Theme]
Name=__TITLE__
Description=__TITLE__ bootsplash (autogenerated)
ModuleName=two-step

[two-step]
ImageDir=__THEME_DIR__
HorizontalAlignment=.5
VerticalAlignment=.5
Transition=none
TransitionDuration=0.0
BackgroundStartColor=0x000000
BackgroundEndColor=0x000000
EOF

# Replace placeholders
sed -i "s|__TITLE__|$title|g; s|__THEME_DIR__|$theme_dir|g" "$theme_dir/$title.plymouth"

log "Theme files created"
log "Installing and setting theme..."
# Set as default and rebuild initramfs
plymouth-set-default-theme -R "$title"
log "Theme set"
